<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>iPhone 水平角度讀取 Demo</title>
  <style>
    body { font-family: system-ui,-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Helvetica,Arial;
           margin: 2rem; line-height: 1.6; }
    button { font-size: 1rem; padding: .6rem 1rem; }
    .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-top: 1rem; }
    .card { border: 1px solid #ccc; border-radius: 12px; padding: 1rem; }
    .big { font-size: 1.75rem; font-weight: 700; }
    #level {
      position: relative; width: 220px; height: 220px; border: 2px solid #999;
      border-radius: 50%; margin-top: 1rem; background: radial-gradient(circle, #f9f9f9, #eee);
      overflow: hidden;
    }
    #bubble {
      position: absolute; width: 36px; height: 36px; border-radius: 50%;
      border: 2px solid #2a2; background: rgba(170,255,170,.7); backdrop-filter: blur(2px);
      left: 50%; top: 50%; transform: translate(-50%, -50%);
    }
    .hint { color:#555; font-size:.9rem; }
  </style>
</head>
<body>
  <h1>讀取 Apple 裝置的水平角度</h1>
  <p class="hint">請在 <b>HTTPS</b> 網站上開啟；首次需點按授權按鈕（iOS 規定）。把手機放在平面上測試更準。</p>

  <button id="btn">請求感測權限並開始</button>

  <div class="grid">
    <div class="card">
      <div>前後傾 (β, beta)</div>
      <div id="beta" class="big">--°</div>
      <div>左右傾 (γ, gamma)</div>
      <div id="gamma" class="big">--°</div>
      <div>偏離水平角（√(β²+γ²)）</div>
      <div id="tilt" class="big">--°</div>
    </div>
    <div class="card">
      <div>方位角（Heading / Azimuth）</div>
      <div id="heading" class="big">--°</div>
      <div class="hint">* 依瀏覽器支援度而定；Safari 可能提供 webkitCompassHeading（0°=正北）。</div>
    </div>
  </div>

  <div class="card" style="margin-top:1rem;">
    <div>簡易水平儀</div>
    <div id="level">
      <div id="bubble"></div>
    </div>
    <div class="hint">圓心表示水平。泡泡偏移代表傾斜方向與大小。</div>
  </div>

  <script>
    const $ = id => document.getElementById(id);
    const fmt = v => (Math.round(v * 10) / 10).toFixed(1);

    let rafId = null;
    const state = { beta: 0, gamma: 0, heading: null };

    function updateUI() {
      $("beta").textContent = fmt(state.beta) + "°";
      $("gamma").textContent = fmt(state.gamma) + "°";
      const tilt = Math.hypot(state.beta, state.gamma);
      $("tilt").textContent = fmt(tilt) + "°";

      $("heading").textContent = state.heading == null ? "--°" : fmt(state.heading) + "°";

      // 泡泡移動：根據 gamma (左右) 與 beta (前後)
      const level = $("level");
      const bubble = $("bubble");
      const R = level.clientWidth / 2;
      const maxOffset = R - bubble.clientWidth / 2 - 6; // 內縮，避免超框
      // 將角度映射成位移（簡化比率，每度 ≈ 2 像素，可自行調整）
      const k = 2;
      let x = state.gamma * k;
      let y = state.beta  * k;
      // 限制在圓內
      const mag = Math.hypot(x, y);
      if (mag > maxOffset) {
        const s = maxOffset / mag;
        x *= s; y *= s;
      }
      bubble.style.left = `calc(50% + ${x}px)`;
      bubble.style.top  = `calc(50% + ${y}px)`;
    }

    function onOrientation(e) {
      // e.beta:   -180..180  (前後傾, 正值=向前低頭) 
      // e.gamma:   -90.. 90  (左右傾, 正值=向右)
      // e.alpha:    0..360   (相對參考方位; Safari 也可能提供 webkitCompassHeading)
      if (typeof e.beta === "number")  state.beta  = e.beta;
      if (typeof e.gamma === "number") state.gamma = e.gamma;

      // 方位角（優先用 webkitCompassHeading；否則用 alpha 當近似）
      let heading = null;
      if (typeof e.webkitCompassHeading === "number" && !isNaN(e.webkitCompassHeading)) {
        heading = e.webkitCompassHeading; // 0 = 北
      } else if (typeof e.alpha === "number") {
        // 注意：alpha 在不同裝置/座標可能非「真北」，僅作參考
        heading = (360 - e.alpha); // 粗略轉成 0=北 的表徵
      }
      state.heading = (heading != null && isFinite(heading)) ? ((heading % 360) + 360) % 360 : null;

      if (!rafId) rafId = requestAnimationFrame(() => {
        rafId = null;
        updateUI();
      });
    }

    async function start() {
      // iOS 13+ 需要使用者手勢觸發的授權
      const needPermission =
        typeof DeviceOrientationEvent !== "undefined" &&
        typeof DeviceOrientationEvent.requestPermission === "function";

      try {
        if (needPermission) {
          const res = await DeviceOrientationEvent.requestPermission();
          if (res !== "granted") {
            alert("未授權感測器存取。請到「設定 > Safari > 隱私權與安全性 > 動作與方向取用」開啟，並重新載入。");
            return;
          }
        }
        window.addEventListener("deviceorientation", onOrientation, { passive: true });

        $("btn").disabled = true;
        $("btn").textContent = "感測中…";
      } catch (err) {
        console.error(err);
        alert("啟用感測器時發生錯誤：" + err);
      }
    }

    $("btn").addEventListener("click", start, { passive: true });
  </script>
</body>
</html>
