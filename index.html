<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>iPhone水平儀歸零實習_教學用</title>
  <style>
    body { font-family: system-ui,-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Helvetica,Arial;
           margin: 2rem; line-height: 1.6; }
    button { font-size: 1rem; padding: .6rem 1rem; }
    .row { display:flex; gap:.75rem; flex-wrap:wrap; }
    .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-top: 1rem; }
    .card { border: 1px solid #ccc; border-radius: 12px; padding: 1rem; }
    .big { font-size: 1.75rem; font-weight: 700; }
    #level {
      position: relative; width: 220px; height: 220px; border: 2px solid #999;
      border-radius: 50%; margin-top: 1rem; background: radial-gradient(circle, #f9f9f9, #eee);
      overflow: hidden;
    }
    #bubble {
      position: absolute; width: 36px; height: 36px; border-radius: 50%;
      border: 2px solid #2a2; background: rgba(170,255,170,.7); backdrop-filter: blur(2px);
      left: 50%; top: 50%; transform: translate(-50%, -50%);
    }
    .hint { color:#555; font-size:.9rem; }
    .ok   { color:#0a0; font-weight:600; }
  </style>
</head>
<body>
  <h1>讀取 Apple 裝置的水平角度（含前後傾角校正歸零）</h1>
  <p class="hint">請在 <b>HTTPS</b> 網站上開啟；需點按授權按鈕（iOS）。</p>

  <div class="row">
    <button id="btn">請求感測權限並開始</button>
    <button id="calBtn" disabled>前後傾角校正歸零</button>
    <button id="resetCal" disabled>清除校正歸零</button>
  </div>

  <div id="calCard" class="card" style="display:none; margin-top:1rem;">
    <strong>兩步驟前傾角校正歸零</strong>
    <ol>
      <li>位置 #1：放置手機，按 <button id="sample1">取樣 #1</button> → <span id="s1">--</span></li>
      <li>翻轉位置 #2：手機翻轉後，按 <button id="sample2" disabled>取樣 #2</button> → <span id="s2">--</span></li>
    </ol>
    <div>計算出的正確傾角 T = (A − B)/2 = <span id="bCorr" class="big">--</span>°</div>
    <div class="row" style="margin-top:.5rem;">
      <button id="applyCal" disabled>套用校正歸零</button>
      <button id="cancelCal">取消</button>
    </div>
  </div>

  <div class="grid">
    <div class="card">
      <div>前後傾 (β, beta) <span id="betaNote" class="hint"></span></div>
      <div id="beta" class="big">--°</div>
      <div>左右傾 (γ, gamma)</div>
      <div id="gamma" class="big">--°</div>
      <div>偏離水平角（√(β²+γ²)）</div>
      <div id="tilt" class="big">--°</div>
    </div>
    <div class="card">
      <div>方位角（Heading / Azimuth）</div>
      <div id="heading" class="big">--°</div>
    </div>
  </div>

  <div class="card" style="margin-top:1rem;">
    <div>簡易水平儀</div>
    <div id="level">
      <div id="bubble"></div>
    </div>
  </div>

  <script>
    const $ = id => document.getElementById(id);
    const fmt = v => (Math.round(v * 10) / 10).toFixed(1);

    let rafId = null;
    const state = {
      betaRaw: 0,
      gammaRaw: 0,
      heading: null,
      correctedBeta: null, // 使用公式 T = (A - B)/2
      cal: { r1: null, r2: null, T: null, E: null }
    };

    function currentBeta() {
      return state.correctedBeta ?? state.betaRaw;
    }

    function currentGamma() {
      return state.gammaRaw;
    }

    function updateUI() {
      const beta = currentBeta();
      const gamma = currentGamma();

      $("beta").textContent  = fmt(beta) + "°";
      $("gamma").textContent = fmt(gamma) + "°";
      $("betaNote").textContent = state.correctedBeta != null ? "(已校正)" : "";

      const tilt = Math.hypot(beta, gamma);
      $("tilt").textContent = fmt(tilt) + "°";
      $("heading").textContent = state.heading == null ? "--°" : fmt(state.heading) + "°";

      const level = $("level");
      const bubble = $("bubble");
      const R = level.clientWidth / 2;
      const maxOffset = R - bubble.clientWidth / 2 - 6;
      const k = 2;
      let x = gamma * k;
      let y = beta  * k;
      const mag = Math.hypot(x, y);
      if (mag > maxOffset) { const s = maxOffset / mag; x *= s; y *= s; }
      bubble.style.left = `calc(50% + ${x}px)`;
      bubble.style.top  = `calc(50% + ${y}px)`;
    }

    function onOrientation(e) {
      if (typeof e.beta === "number")  state.betaRaw  = e.beta;
      if (typeof e.gamma === "number") state.gammaRaw = e.gamma;

      let heading = null;
      if (typeof e.webkitCompassHeading === "number" && !isNaN(e.webkitCompassHeading)) {
        heading = e.webkitCompassHeading;
      } else if (typeof e.alpha === "number") {
        heading = (360 - e.alpha);
      }
      state.heading = (heading != null && isFinite(heading)) ? ((heading % 360) + 360) % 360 : null;

      if (!rafId) rafId = requestAnimationFrame(() => { rafId = null; updateUI(); });
    }

    async function start() {
      const needPermission =
        typeof DeviceOrientationEvent !== "undefined" &&
        typeof DeviceOrientationEvent.requestPermission === "function";
      try {
        if (needPermission) {
          const res = await DeviceOrientationEvent.requestPermission();
          if (res !== "granted") {
            alert("未授權感測器存取，請到設定開啟「動作與方向取用」。");
            return;
          }
        }
        window.addEventListener("deviceorientation", onOrientation, { passive: true });
        $("btn").disabled = true;
        $("btn").textContent = "感測中…";
        $("calBtn").disabled = false;
        $("resetCal").disabled = false;
      } catch (err) {
        console.error(err);
        alert("啟用感測器錯誤：" + err);
      }
    }

    // ===== 新版：根據公式 T = (A - B)/2 =====
    function startCal() {
      state.cal = { r1: null, r2: null, T: null, E: null };
      $("s1").textContent = "--"; $("s2").textContent = "--"; $("bCorr").textContent = "--";
      $("sample1").disabled = false;
      $("sample2").disabled = true;
      $("applyCal").disabled = true;
      $("calCard").style.display = "block";
    }

    function sample1() {
      state.cal.r1 = state.betaRaw;
      $("s1").textContent = fmt(state.cal.r1) + "°";
      $("sample1").disabled = true;
      $("sample2").disabled = false;
    }

    function sample2() {
      state.cal.r2 = state.betaRaw;
      $("s2").textContent = fmt(state.cal.r2) + "°";

      // 計算正確傾角 T = (A - B) / 2
      state.cal.T = (state.cal.r1 - state.cal.r2) / 2;

      // 計算儀器誤差 E = (A + B) / 2（如需使用）
      state.cal.E = (state.cal.r1 + state.cal.r2) / 2;

      $("bCorr").textContent = fmt(state.cal.T);
      $("applyCal").disabled = false;
    }

    function applyCal() {
      state.correctedBeta = state.cal.T ?? 0;
      $("calCard").style.display = "none";
      updateUI();
    }

    function cancelCal() {
      $("calCard").style.display = "none";
    }

    function clearCal() {
      state.correctedBeta = null;
      updateUI();
      alert("已清除校正歸零值。");
    }

    $("btn").addEventListener("click", start, { passive: true });
    $("calBtn").addEventListener("click", startCal, { passive: true });
    $("resetCal").addEventListener("click", clearCal, { passive: true });
    $("sample1").addEventListener("click", sample1, { passive: true });
    $("sample2").addEventListener("click", sample2, { passive: true });
    $("applyCal").addEventListener("click", applyCal, { passive: true });
    $("cancelCal").addEventListener("click", cancelCal, { passive: true });
  </script>
</body>
</html>
